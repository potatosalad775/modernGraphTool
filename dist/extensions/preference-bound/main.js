import{StringLoader as e,FRParser as t,FRNormalizer as n,RenderEngine as r}from"../../core.min.js";function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _extends(){return _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_extends.apply(this,arguments)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}(e))||t){n&&(e=n);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){i=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(i)throw a}}}}function decasteljau(e,t){var n=[],r=[];return e.length&&function decasteljauRecurse(e,t){if(1===e.length)n.push(e[0]),r.push(e[0]);else{for(var a=Array(e.length-1),o=0;o<a.length;o++)0===o&&n.push(e[0]),o===a.length-1&&r.push(e[o+1]),a[o]=[(1-t)*e[o][0]+t*e[o+1][0],(1-t)*e[o][1]+t*e[o+1][1]];decasteljauRecurse(a,t)}}(e,t),{left:n,right:r.reverse()}}function pointsToCommand(e){var t={};return 4===e.length&&(t.x2=e[2][0],t.y2=e[2][1]),e.length>=3&&(t.x1=e[1][0],t.y1=e[1][1]),t.x=e[e.length-1][0],t.y=e[e.length-1][1],4===e.length?t.type="C":3===e.length?t.type="Q":t.type="L",t}function splitCurve(e,t,n){var r=[[e.x,e.y]];return null!=t.x1&&r.push([t.x1,t.y1]),null!=t.x2&&r.push([t.x2,t.y2]),r.push([t.x,t.y]),function(e,t){for(var n=[],r=e,a=1/(t=t||2),o=0;o<t-1;o++){var i=decasteljau(r,a/(1-a*o));n.push(i.left),r=i.right}return n.push(r),n}(r,n).map(pointsToCommand)}var a=/[MLCSTQAHVZmlcstqahv]|-?[\d.e+-]+/g,o={M:["x","y"],L:["x","y"],H:["x"],V:["y"],C:["x1","y1","x2","y2","x","y"],S:["x2","y2","x","y"],Q:["x1","y1","x","y"],T:["x","y"],A:["rx","ry","xAxisRotation","largeArcFlag","sweepFlag","x","y"],Z:[]};function arrayOfLength(e,t){for(var n=Array(e),r=0;r<e;r++)n[r]=t;return n}function commandToString(e){return"".concat(e.type).concat(o[e.type].map((function(t){return e[t]})).join(","))}function extend(e,t,n){var r=e.length-1,a=t.length-1,o=r/a,i=arrayOfLength(a).reduce((function(t,r,a){var i=Math.floor(o*a);if(n&&i<e.length-1&&n(e[i],e[i+1])){var s=o*a%1<.5;t[i]&&(s?i>0?i-=1:i<e.length-1&&(i+=1):i<e.length-1?i+=1:i>0&&(i-=1))}return t[i]=(t[i]||0)+1,t}),[]).reduce((function(t,n,r){if(r===e.length-1){var a=arrayOfLength(n,_extends({},e[e.length-1]));return"M"===a[0].type&&a.forEach((function(e){e.type="L"})),t.concat(a)}return t.concat(function(e,t,n){var r=[];if("L"===t.type||"Q"===t.type||"C"===t.type)r=r.concat(splitCurve(e,t,n));else{var a=_extends({},e);"M"===a.type&&(a.type="L"),(r=r.concat(arrayOfLength(n-1).map((function(){return a})))).push(t)}return r}(e[r],e[r+1],n))}),[]);return i.unshift(e[0]),i}function pathCommandsFromString(e){for(var t,n,r=(e||"").match(a)||[],i=[],s=0;s<r.length;++s)if(t=o[r[s]]){n={type:r[s]};for(var u=0;u<t.length;++u)n[t[u]]=+r[s+u+1];s+=t.length,i.push(n)}return i}function interpolatePathCommands(e,t,n){var r=null==e?[]:e.slice(),a=null==t?[]:t.slice(),i="object"===_typeof(n)?n:{excludeSegment:n,snapEndsToInput:!0},s=i.excludeSegment,u=i.snapEndsToInput;if(!r.length&&!a.length)return function(){return[]};var c=!(0!==r.length&&"Z"!==r[r.length-1].type||0!==a.length&&"Z"!==a[a.length-1].type);r.length>0&&"Z"===r[r.length-1].type&&r.pop(),a.length>0&&"Z"===a[a.length-1].type&&a.pop(),r.length?a.length||a.push(r[0]):r.push(a[0]),0!==Math.abs(a.length-r.length)&&(a.length>r.length?r=extend(r,a,s):a.length<r.length&&(a=extend(a,r,s)));var l=(r=r.map((function(e,t){return function(e,t){var n={x1:"x",y1:"y",x2:"x",y2:"y"},r=["xAxisRotation","largeArcFlag","sweepFlag"];if(e.type!==t.type&&"M"!==t.type.toUpperCase()){var a={};Object.keys(t).forEach((function(o){var i=t[o],s=e[o];void 0===s&&(r.includes(o)?s=i:(void 0===s&&n[o]&&(s=e[n[o]]),void 0===s&&(s=0))),a[o]=s})),a.type=t.type,e=a}return e}(e,a[t])}))).map((function(e){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e)}));return c&&(l.push({type:"Z"}),r.push({type:"Z"})),function(e){if(1===e&&u)return null==t?[]:t;if(0===e)return r;for(var n=0;n<l.length;++n){var i,s=r[n],c=a[n],d=l[n],h=_createForOfIteratorHelper(o[d.type]);try{for(h.s();!(i=h.n()).done;){var p=i.value;d[p]=(1-e)*s[p]+e*c[p],"largeArcFlag"!==p&&"sweepFlag"!==p||(d[p]=Math.round(d[p]))}}catch(e){h.e(e)}finally{h.f()}}return l}}function interpolatePath(e,t,n){var r=pathCommandsFromString(e),a=pathCommandsFromString(t),o="object"===_typeof(n)?n:{excludeSegment:n,snapEndsToInput:!0},i=o.excludeSegment,s=o.snapEndsToInput;if(!r.length&&!a.length)return function(){return""};var u=interpolatePathCommands(r,a,{excludeSegment:i,snapEndsToInput:s});return function(e){if(1===e&&s)return null==t?"":t;var n,r="",a=_createForOfIteratorHelper(u(e));try{for(a.s();!(n=a.n()).done;){r+=commandToString(n.value)}}catch(e){a.e(e)}finally{a.f()}return r}}Object.keys(o).forEach((function(e){o[e.toLowerCase()]=o[e]}));class PreferenceBoundExtension{constructor(e={}){this.config=e,this.boundDataU=null,this.boundDataD=null,this.baseDFTargetData=null,this.boundsVisible=!1,this.preferenceBoundArea=null,this.pathData={raw:null,comp:null},this.previousBaselineUUID=null,this.buttonId="ext-preference-bound-toggle"}async init(){try{await this.loadBoundData(),await this.loadBaseDFTargetData(),this.createToggleButton(),this.togglePreferenceBounds(this.config.ENABLE_BOUND_ON_INITIAL_LOAD||!1),window.addEventListener("core:fr-baseline-updated",this.updatePath.bind(this,!0)),window.addEventListener("core:fr-normalized",this.updateNormalization.bind(this));const t=document.querySelector("graph-scale-button gt-button");t&&t.addEventListener("click",this.updateYScale.bind(this)),e.addObserver(this.updateLanguage.bind(this))}catch(e){console.error("Preference Bound Extension: Initialization failed",e)}}async loadBoundData(){try{const e=await fetch(import.meta.resolve(`./data/${this.config.BOUND_DATA_FILE||"Bounds"} U.txt`));if(!e.ok)throw new Error(`Failed to load Bounds U.txt: ${e.statusText}`);const n=await e.text();this.boundDataU=await t.parseFRData(n);const r=await fetch(import.meta.resolve(`./data/${this.config.BOUND_DATA_FILE||"Bounds"} D.txt`));if(!r.ok)throw new Error(`Failed to load Bounds D.txt: ${r.statusText}`);const a=await r.text();this.boundDataD=await t.parseFRData(a)}catch(e){throw console.error("Preference Bound Extension: Error loading bound data",e),this.boundDataU={},this.boundDataD={},e}}async loadBaseDFTargetData(){try{const e=this.config.BASE_DF_TARGET_FILE+(this.config.BASE_DF_TARGET_FILE.endsWith(".txt")?"":this.config.BASE_DF_TARGET_FILE.endsWith(" Target")?".txt":" Target.txt");if(!e)return void console.warn("Preference Bound Extension: No BASE_DF_TARGET_FILE specified in config.");const r=await fetch(import.meta.resolve(`./data/${e}`));if(!r.ok)throw new Error(`Failed to load Bounds U.txt: ${r.statusText}`);const a=await r.text(),o=await t.parseFRData(a);this.baseDFTargetData=n.normalize(o)}catch(e){throw console.error("Preference Bound Extension: Error loading base DF target data",e),this.baseDFTargetData={},e}}async createToggleButton(){let t=0;for(;t<5;){const n=document.querySelector(".graph-button-container");if(n){const t=document.createElement("style");t.innerHTML=i,n.parentNode.appendChild(t);const r=document.createElement("button");return r.id=this.buttonId,r.innerHTML=`\n          ${e.getString("extension.preference-bound.button.toggle","Preference Bound")}\n        `,r.title="Toggle Preference Bounds",r.addEventListener("click",(()=>this.togglePreferenceBounds())),void n.insertBefore(r,n.firstChild)}await new Promise((e=>setTimeout(e,100))),t++}console.warn("Preference Bound Extension: Could not find a suitable place to add the toggle button after multiple attempts. componentManager.addButton or #graph-controls or .graph-toolbar-secondary not found.")}togglePreferenceBounds(e){this.boundsVisible="boolean"==typeof e?e:!this.boundsVisible,this.boundsVisible?this.drawPreferenceBounds():this.removePreferenceBounds();const t=document.getElementById(this.buttonId);t&&t.classList.toggle("active",this.boundsVisible)}drawPreferenceBounds(){const e=d3.select("#fr-graph");if(!e||!this.boundDataU||!this.boundDataD||0===this.boundDataU.data.length||0===this.boundDataD.data.length)return void console.warn("Preference Bound Extension: Cannot draw bounds, missing data or renderEngine.");this.removePreferenceBounds(),this.updatePathData(),e.select(".fr-graph-curve-container");const t=e.insert("g",".fr-graph-curve-container").attr("class","preference-bound-area-group");this.preferenceBoundArea=t.append("path").attr("d",null===r.baselineData.uuid?this.pathData.raw:this.pathData.comp).attr("fill",this.config.COLOR_FILL||"rgba(180, 180, 180, 0.2)").attr("stroke",this.config.COLOR_BORDER||"rgba(120, 120, 120, 0.2)").attr("stroke-width",1)}removePreferenceBounds(){this.preferenceBoundArea&&(this.preferenceBoundArea.remove(),this.preferenceBoundArea=null);const e=d3.select("#fr-graph");e&&e.select(".preference-bound-area-group").remove()}updatePathData(){const{xScale:e,yScale:t}=r.getScales(),n=d3.line().x((t=>e(t[0]))).y((e=>t(e[1]))).curve(d3.curveLinear),a=d3.line().x((t=>e(t[0]))).y((e=>{if(!this.baseDFTargetData.data)return t(e[1]);const n=d3.bisector((e=>e[0])).left,r=n(this.baseDFTargetData.data,e[0],0),a=this.baseDFTargetData.data[r-1],o=this.baseDFTargetData.data[r];let i=0;if(a&&o){const t=(e[0]-a[0])/(o[0]-a[0]);i=a[1]+t*(o[1]-a[1])}else a?i=a[1]:o&&(i=o[1]);return t(i+e[1])})).curve(d3.curveNatural);this.pathData={raw:a(this.boundDataU.data)+a(this.boundDataD.data.slice().reverse()).replace(/^M/,"L")+"Z",comp:n(this.boundDataU.data)+n(this.boundDataD.data.slice().reverse()).replace(/^M/,"L")+"Z"}}updatePath(e=!1){if(!this.boundsVisible)return;const t=this;null!==r.baselineData.uuid&&null===this.previousBaselineUUID?this.preferenceBoundArea.transition().duration(e?300:0).attrTween("d",(e=>interpolatePath(t.pathData.raw,t.pathData.comp))):this.preferenceBoundArea.transition().duration(e?300:0).attrTween("d",(e=>interpolatePath(t.pathData.comp,t.pathData.raw))),this.previousBaselineUUID=r.baselineData.uuid}updateYScale(e){this.boundsVisible&&(this.updatePathData(),this.updatePath(!0))}updateNormalization(e){if(!this.boundsVisible)return;const t=this.pathData,a=n.normalize(this.baseDFTargetData);this.baseDFTargetData=a,this.updatePathData();const o=this;null!==r.baselineData.uuid&&null===this.previousBaselineUUID?this.preferenceBoundArea.transition().duration(0).attrTween("d",(e=>interpolatePath(t.comp,o.pathData.comp))):this.preferenceBoundArea.transition().duration(0).attrTween("d",(e=>interpolatePath(t.raw,o.pathData.raw)))}updateLanguage(){const t=document.getElementById(this.buttonId);t&&(t.innerHTML=`\n        ${e.getString("extension.preference-bound.button.toggle","Preference Bound")}\n      `)}destroy(){this.removePreferenceBounds();const e=document.getElementById(this.buttonId);e&&e.remove(),console.log("Preference Bound Extension: Destroyed.")}}const i="\n  #ext-preference-bound-toggle {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    height: 2.5rem;\n    padding: 0.5rem 1rem;\n    border-radius: 2.5rem;\n    cursor: pointer;\n    font-family: inherit;\n    font-size: 0.8rem;\n    font-weight: 500;\n    transition: all 0.2s ease;\n    gap: 0.5rem;\n    background: var(--gt-color-primary-container);\n    color: var(--gt-color-on-primary-container);\n    border: none;\n  }\n\n  #ext-preference-bound-toggle.active {\n    background: var(--gt-color-primary);\n    color: var(--gt-color-on-primary);\n  }\n\n  @media (hover: hover) and (pointer: fine) {\n    #ext-preference-bound-toggle:not(.active):hover {\n      filter: var(--gt-hover-filter);\n    }\n    \n    #ext-preference-bound-toggle.active:hover {\n      filter: var(--gt-hover-filter);\n    }\n  }\n";export{PreferenceBoundExtension as default};
//# sourceMappingURL=main.js.map
