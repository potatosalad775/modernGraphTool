import{MenuState as e,DataProvider as t,StringLoader as i,FRParser as n}from"../../core.min.js";class Equalizer{constructor(){this.config={DefaultSampleRate:48e3,TrebleStartFrom:7e3,AutoEQRange:[20,15e3],OptimizeQRange:[.5,2],OptimizeGainRange:[-12,12],OptimizeDeltas:[[10,10,10,5,.1,.5],[10,10,10,2,.1,.2],[10,10,10,1,.1,.1]],GraphicEQRawFrequences:new Array(Math.ceil(Math.log(1e3)/Math.log(1.0072))).fill(null).map(((e,t)=>20*Math.pow(1.0072,t))),GraphicEQFrequences:Array.from(new Set(new Array(Math.ceil(Math.log(1e3)/Math.log(1.0563))).fill(null).map(((e,t)=>Math.floor(20*Math.pow(1.0563,t)))))).sort(((e,t)=>e-t))}}_interpolate(e,t){let i=0;return e.map((e=>{for(;i<t.length-1;++i){let[n,r]=t[i],[a,s]=t[i+1];if(0==i&&e<n)return[e,r];if(e>=n&&e<a){return[e,r+(s-r)*(e-n)/(a-n)]}}return[e,t[t.length-1][1]]}))}_lowshelf(e,t,i){e/=this.config.DefaultSampleRate,e=Math.max(1e-6,Math.min(e,1)),t=Math.max(1e-4,Math.min(t,1e3)),i=Math.max(-40,Math.min(i,40));let n=2*Math.PI*e,r=Math.sin(n),a=Math.cos(n),s=Math.pow(10,i/40),l=r/(2*t),o=2*Math.sqrt(s)*l||0,u=s+1+(s-1)*a+o;return[1,-2*(s-1+(s+1)*a)/u,(s+1+(s-1)*a-o)/u,s*(s+1-(s-1)*a+o)/u,2*s*(s-1-(s+1)*a)/u,s*(s+1-(s-1)*a-o)/u]}_highshelf(e,t,i){e/=this.config.DefaultSampleRate,e=Math.max(1e-6,Math.min(e,1)),t=Math.max(1e-4,Math.min(t,1e3)),i=Math.max(-40,Math.min(i,40));let n=2*Math.PI*e,r=Math.sin(n),a=Math.cos(n),s=Math.pow(10,i/40),l=r/(2*t),o=2*Math.sqrt(s)*l||0,u=s+1-(s-1)*a+o;return[1,2*(s-1-(s+1)*a)/u,(s+1-(s-1)*a-o)/u,s*(s+1+(s-1)*a+o)/u,-2*s*(s-1+(s+1)*a)/u,s*(s+1+(s-1)*a-o)/u]}_peaking(e,t,i){e/=this.config.DefaultSampleRate,e=Math.max(1e-6,Math.min(e,1)),t=Math.max(1e-4,Math.min(t,1e3)),i=Math.max(-40,Math.min(i,40));let n=2*Math.PI*e,r=Math.sin(n),a=Math.cos(n),s=r/(2*t),l=Math.pow(10,i/40),o=1+s/l;return[1,-2*a/o,(1-s/l)/o,(1+s*l)/o,-2*a/o,(1-s*l)/o]}_calculateGains(e,t){let i=new Array(e.length).fill(0);for(let n=0;n<t.length;++n){let[r,a,s,l,o,u]=t[n];for(let t=0;t<e.length;++t){let n=2*Math.PI*e[t]/this.config.DefaultSampleRate,c=4*Math.pow(Math.sin(n/2),2),h=10*Math.log10(Math.pow(l+o+u,2)+(l*u*c-(o*(l+u)+4*l*u))*c)-10*Math.log10(Math.pow(r+a+s,2)+(r*s*c-(a*(r+s)+4*r*s))*c);i[t]+=h}}return i}calculateGainsFromFilter(e,t){const i=this._filtersToCoeffs(t);return this._calculateGains(e,i)}calculatePreamp(e,t){const i=e,n=this.applyFilters(e,t);let r=-1/0;for(let e=0;e<i.length;++e)r=Math.max(r,n[e][1]-i[e][1]);return-r}_calculateDistance(e,t){let i=0;for(let n=0;n<e.length;++n){let r=Math.abs(e[n][1]-t[n][1]);i+=r>=.1?r:0}return i/e.length}_filtersToCoeffs(e){return e.map((e=>e.freq&&e.gain&&e.q?"LSQ"===e.type?this._lowshelf(e.freq,e.q,e.gain):"HSQ"===e.type?this._highshelf(e.freq,e.q,e.gain):"PK"===e.type?this._peaking(e.freq,e.q,e.gain):null:null)).filter((e=>e))}_normalizeResolution(e,t){const i=[20],n=Math.pow(2,1/48);for(;i[i.length-1]<2e4;)i.push(i[i.length-1]*n);const r=this._interpolatePoints(i,e),a=this._interpolatePoints(i,t);let s=i.findIndex((e=>e>=1e3)),l=s;const o=r[s][1]-a[l][1];return{source:r,target:a.map((e=>[e[0],e[1]+o]))}}_interpolatePoints(e,t){if(!t||0===t.length)return e.map((e=>[e,0]));const i=[...t].sort(((e,t)=>e[0]-t[0]));return e.map((e=>{let t=0;for(;t<i.length-1&&i[t+1][0]<e;)t++;if(t>=i.length-1)return[e,i[i.length-1][1]];if(t<0||e<=i[0][0])return[e,i[0][1]];{const[n,r]=i[t],[a,s]=i[t+1];return[e,r+Math.log(e/n)/Math.log(a/n)*(s-r)]}}))}applyFilters(e,t){let i=e.map((e=>e[0])),n=this._filtersToCoeffs(t),r=this._calculateGains(i,n);return i.map(((t,i)=>[t,e[i][1]+r[i]]))}_searchCandidates(e,t,i){let n=0,r=-1,a=[],[s,l]=this.config.AutoEQRange;for(let o=0;o<e.length;++o){let[u,c]=e[o],h=c-t[o][1],d=Math.abs(h),p=d<i?0:h/d;if(p!==n){if(r>=0){if(0!=n){let i=e[r][0],n=u,c=Math.sqrt(i*n),h=this._interpolate([c],t.slice(r,o))[0][1]-this._interpolate([c],e.slice(r,o))[0][1],d=c/(n-i);c>=s&&c<=l&&a.push({type:"PK",freq:c,q:d,gain:h})}r=-1}else r=o;n=p}}return a}_freqUnit(e){return e<100?1:e<1e3?10:e<1e4?100:1e3}_round(e,t=1){const i=Math.pow(10,t);return Math.round(e*i)/i}_stripFilters(e){let[t,i]=this.config.OptimizeQRange,[n,r]=this.config.OptimizeGainRange;return e.map((e=>({type:e.type,freq:Math.floor(e.freq-e.freq%this._freqUnit(e.freq)),q:Math.min(Math.max(e.q,t),i),gain:Math.min(Math.max(e.gain,n),r)})))}convertFilterAsGraphicEQ(e){let t=this.config.GraphicEQRawFrequences,i=this.config.GraphicEQFrequences,n=this._filtersToCoeffs(e),r=this._calculateGains(t,n),a=t.map(((e,t)=>[e,r[t]])),s=0,l=i.map(((e,n)=>{let r=n<i.length-1?Math.sqrt(e*i[n+1]):2e4,l=[];for(;s<t.length&&t[s]<r;++s)l.push(a[s][1]);return[e,l.reduce(((e,t)=>e+t),0)/l.length]})),o=l.reduce(((e,t)=>e>t[1]?e:t[1]),-1/0);return l=l.map((([e,t])=>[e,t-o])),l}_optimize(e,t,i,n,r=!1){i=this._stripFilters(i);let[a,s]=this.config.AutoEQRange,[l,o]=this.config.OptimizeQRange,[u,c]=this.config.OptimizeGainRange,[h,d,p,g,f,m]=this.config.OptimizeDeltas[n],[q,y,S]=r?[i.length-1,-1,-1]:[0,i.length,1];for(let n=q;n!=y;n+=S){let r=i[n],q=this.applyFilters(e,i.filter(((e,t)=>t!==n))),y=r,S=this._calculateDistance(this.applyFilters(q,[r]),t);const v="LSQ"===r.type||"HSQ"===r.type,x=v?"LSQ"===r.type?20:4e3:a,b=v?"LSQ"===r.type?400:16e3:s,_=v?.3:l,E=v?1.5:o;let testNewFilter=(e,i,n)=>{let a=r.freq+e*this._freqUnit(r.freq)*g,s=r.q+i*f,l=r.gain+n*m;if(a<x||a>b||s<_||s>E||l<u||l>c)return!1;let o={type:r.type,freq:a,q:s,gain:l},h=this.applyFilters(q,[o]),d=this._calculateDistance(h,t);return d<S&&(y=o,S=d,!0)},w=!0,M=50,L=0;for(;w&&L<M;){w=!1,L++;for(let e=-h;e<=h&&!w;e++)0!==e&&testNewFilter(e,0,0)&&(r=y,w=!0);for(let e=-d;e<=d&&!w;e++)0!==e&&testNewFilter(0,e,0)&&(r=y,w=!0);for(let e=-p;e<=p&&!w;e++)0!==e&&testNewFilter(0,0,e)&&(r=y,w=!0)}for(let e=-h;e<=h;++e)for(let t=d;t>=-d;--t){for(let i=0;i<=p&&testNewFilter(e,t,i);++i);for(let i=0;i>=-p&&testNewFilter(e,t,i);--i);}i[n]=y}return i.sort(((e,t)=>e.freq-t.freq))}_analyzeShelfOpportunities(e,t){const[i,n]=this.config.AutoEQRange,r=[],a=e.filter((e=>e[0]>=i&&e[0]<=200)),s=t.filter((e=>e[0]>=i&&e[0]<=200));if(a.length>0&&s.length>0){let e=0,t=0;for(let i=0;i<a.length;i++)e+=s[i][1]-a[i][1],t++;const i=e/t;if(Math.abs(i)>1.5){let e=100;for(let t=a.length-1;t>=0;t--){const n=s[t][1]-a[t][1];if(!(Math.sign(n)===Math.sign(i)&&Math.abs(n)>1))break;e=a[t][0]}r.push({type:"LSQ",freq:Math.max(e,50),q:.7,gain:i})}}const l=e.filter((e=>e[0]>=8e3&&e[0]<=n)),o=t.filter((e=>e[0]>=8e3&&e[0]<=n));if(l.length>0&&o.length>0){let e=0,t=0;for(let i=0;i<l.length;i++)e+=o[i][1]-l[i][1],t++;const i=e/t;if(Math.abs(i)>1.5){let e=8e3;for(let t=0;t<l.length;t++){const n=o[t][1]-l[t][1];if(Math.sign(n)===Math.sign(i)&&Math.abs(n)>1){e=l[t][0];break}}r.push({type:"HSQ",freq:Math.min(e,12e3),q:.7,gain:i})}}return r}_calculateWeightedError(e,t){let i=0;for(let n=0;n<e.length;n++){const r=Math.abs(e[n][1]-t[n][1]);i+=r*r}return Math.sqrt(i/e.length)}_scoreCandidates(e,t,i){return i.map((i=>{const n=this.applyFilters(e,[i]),r=this._calculateWeightedError(e,t)-this._calculateWeightedError(n,t);return{...i,score:r,coverage:Math.abs(i.gain)/i.q}})).filter((e=>e.score>0)).sort(((e,t)=>t.score-e.score))}_optimizeShelfFilter(e,t,i){const n="LSQ"===i.type,[r,a]=this.config.OptimizeGainRange;let s={...i},l=this._calculateWeightedError(this.applyFilters(e,[i]),t);const o=n?[30,50,70,100,120,150,200,250,300]:[4e3,5e3,6e3,7e3,8e3,9e3,1e4,11e3,12e3],u=[.4,.5,.6,.7,.8,1,1.2,1.5];for(const n of o)for(const o of u){let u=r,c=a;for(;c-u>.2;){const r=(u+c)/2,a={type:i.type,freq:n,q:o,gain:r-.5},s={type:i.type,freq:n,q:o,gain:r+.5};this._calculateWeightedError(this.applyFilters(e,[a]),t)<this._calculateWeightedError(this.applyFilters(e,[s]),t)?c=r:u=r}const h=(u+c)/2,d={type:i.type,freq:n,q:o,gain:h},p=this._calculateWeightedError(this.applyFilters(e,[d]),t);p<l&&(s=d,l=p)}return s}_iterativeBatchOptimization(e,t,i,n){let r=[...i],a=this.applyFilters(e,r);for(;r.length<n;){const i=this._searchCandidates(a,t,.3);if(0===i.length)break;const n=this._scoreCandidates(a,t,i);if(0===n.length)break;const s=n[0];r.push({type:s.type,freq:s.freq,q:s.q,gain:s.gain});for(let i=0;i<this.config.OptimizeDeltas.length;i++)r=this._optimize(e,t,r,i),r=this._optimize(e,t,r,i,!0);a=this.applyFilters(e,r);if(this._calculateWeightedError(a,t)<.5)break}return r}autoEQ(e,t,i={}){const n=i.maxFilters||8,r=i.freqRange||this.config.AutoEQRange,a=i.qRange||this.config.OptimizeQRange,s=i.gainRange||this.config.OptimizeGainRange,l=!1!==i.useShelfFilter;this.config.AutoEQRange=r,this.config.OptimizeQRange=a,this.config.OptimizeGainRange=s;const o=this._normalizeResolution(e,t),u=o.source.filter((e=>e[0]>=r[0]&&e[0]<=r[1])),c=o.target.filter((e=>e[0]>=r[0]&&e[0]<=r[1]));let h=[],d=n;if(l){const e=this._analyzeShelfOpportunities(u,c);for(const t of e){if(d<=2)break;const e=this._optimizeShelfFilter(u,c,t),i=this.applyFilters(u,[...h,e]),n=this.applyFilters(u,h);this._calculateWeightedError(n,c)-this._calculateWeightedError(i,c)>.3&&(h.push(e),d--)}}let p=this._iterativeBatchOptimization(u,c,h,n);for(let e=0;e<this.config.OptimizeDeltas.length;e++)p=this._optimize(u,c,p,e),p=this._optimize(u,c,p,e,!0);return p=this._pruneIneffectiveFilters(u,c,p),p.map((e=>({type:e.type,freq:this._round(e.freq,0),q:this._round(e.q,2),gain:this._round(e.gain,1)}))).sort(((e,t)=>e.freq-t.freq))}_pruneIneffectiveFilters(e,t,i){const n=this._calculateWeightedError(this.applyFilters(e,i),t);return i.filter(((r,a)=>{const s=i.filter(((e,t)=>t!==a));return this._calculateWeightedError(this.applyFilters(e,s),t)-n>.1}))}}const r={iconPath:{plus:'<path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path>',subtract:'<path d="M5 11V13H19V11H5Z"></path>',sortDesc:'<path d="M20 4V16H23L19 21L15 16H18V4H20ZM12 18V20H3V18H12ZM14 11V13H3V11H14ZM14 4V6H3V4H14Z"></path>',import:'<path d="M13 10H18L12 16L6 10H11V3H13V10ZM4 19H20V12H22V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V12H4V19Z"></path>',export:'<path d="M4 19H20V12H22V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V12H4V19ZM13 9V16H11V9H6L12 3L18 9H13Z"></path>',arrowDown:'<path d="M11.9999 13.1714L16.9497 8.22168L18.3639 9.63589L11.9999 15.9999L5.63599 9.63589L7.0502 8.22168L11.9999 13.1714Z"></path>',volumeMute:'<path d="M5.88889 16.0001H2C1.44772 16.0001 1 15.5524 1 15.0001V9.00007C1 8.44778 1.44772 8.00007 2 8.00007H5.88889L11.1834 3.66821C11.3971 3.49335 11.7121 3.52485 11.887 3.73857C11.9601 3.8279 12 3.93977 12 4.05519V19.9449C12 20.2211 11.7761 20.4449 11.5 20.4449C11.3846 20.4449 11.2727 20.405 11.1834 20.3319L5.88889 16.0001ZM20.4142 12.0001L23.9497 15.5356L22.5355 16.9498L19 13.4143L15.4645 16.9498L14.0503 15.5356L17.5858 12.0001L14.0503 8.46454L15.4645 7.05032L19 10.5859L22.5355 7.05032L23.9497 8.46454L20.4142 12.0001Z"></path>',volumeFull:'<path d="M2 16.0001H5.88889L11.1834 20.3319C11.2727 20.405 11.3846 20.4449 11.5 20.4449C11.7761 20.4449 12 20.2211 12 19.9449V4.05519C12 3.93977 11.9601 3.8279 11.887 3.73857C11.7121 3.52485 11.3971 3.49335 11.1834 3.66821L5.88889 8.00007H2C1.44772 8.00007 1 8.44778 1 9.00007V15.0001C1 15.5524 1.44772 16.0001 2 16.0001ZM23 12C23 15.292 21.5539 18.2463 19.2622 20.2622L17.8445 18.8444C19.7758 17.1937 21 14.7398 21 12C21 9.26016 19.7758 6.80629 17.8445 5.15557L19.2622 3.73779C21.5539 5.75368 23 8.70795 23 12ZM18 12C18 10.0883 17.106 8.38548 15.7133 7.28673L14.2842 8.71584C15.3213 9.43855 16 10.64 16 12C16 13.36 15.3213 14.5614 14.2842 15.2841L15.7133 16.7132C17.106 15.6145 18 13.9116 18 12Z"></path>',play:'<path d="M19.376 12.4161L8.77735 19.4818C8.54759 19.635 8.23715 19.5729 8.08397 19.3432C8.02922 19.261 8 19.1645 8 19.0658V4.93433C8 4.65818 8.22386 4.43433 8.5 4.43433C8.59871 4.43433 8.69522 4.46355 8.77735 4.5183L19.376 11.584C19.6057 11.7372 19.6678 12.0477 19.5146 12.2774C19.478 12.3323 19.4309 12.3795 19.376 12.4161Z"></path>',pause:'<path d="M6 5H8V19H6V5ZM16 5H18V19H16V5Z"></path>',previous:'<path d="M8 11.3333L18.2227 4.51823C18.4524 4.36506 18.7628 4.42714 18.916 4.65691C18.9708 4.73904 19 4.83555 19 4.93426V19.0657C19 19.3419 18.7761 19.5657 18.5 19.5657C18.4013 19.5657 18.3048 19.5365 18.2227 19.4818L8 12.6667V19C8 19.5523 7.55228 20 7 20C6.44772 20 6 19.5523 6 19V5C6 4.44772 6.44772 4 7 4C7.55228 4 8 4.44772 8 5V11.3333Z"></path>'},getSVG(e,t=""){return`\n    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"\n      style="${""!==t?t:"width: 1rem; height: 1rem;"}"\n    >\n      ${this.iconPath[e]}\n    </svg>\n    `}},a={name:"equalizer",version:"1.1.0",apiLevel:1,coreMinVersion:"1.0.0",coreMaxVersion:"1.0.x",description:"Parametric equalizer extension for modernGraphTool",author:"potatosalad775"};class EqualizerExtension extends HTMLElement{constructor(e={}){super(),this.config=e,this.currentFilters={filters:[],preamp:null},this.currentDeviceUUID={source:null,target:null},this.currentSourceUUID=null,(async()=>{await this._initializeComponents(),this._initializeStyles(),this._setupEventListeners(),this.audioPlayer=this.querySelector("eq-audio-player")})()}async _initializeComponents(){await Promise.resolve().then((function(){return s})),await Promise.resolve().then((function(){return l})),await Promise.resolve().then((function(){return o})),await Promise.resolve().then((function(){return u})),await Promise.resolve().then((function(){return c})),this.innerHTML='\n      <div class="equalizer-container">\n        <div class="eq-controls">\n          <eq-filter-list></eq-filter-list>\n        </div>\n        <div class="eq-controls">\n          <eq-select></eq-select>\n          <eq-autoeq></eq-autoeq>\n          <eq-audio-player></eq-audio-player>\n          <eq-uploader></eq-uploader>\n        </div>\n      </div>\n    ';[this.querySelector("eq-filter-list"),this.querySelector("eq-autoeq")].forEach((e=>{e&&e.setConfig?.(this.config)}))}_initializeStyles(){const e=document.createElement("style");e.textContent='\n  equalizer-extension {\n    display: block;\n    container-type: inline-size;\n    container-name: equalizer-host;\n  }\n    \n  .equalizer-container {\n    display: grid;\n    grid-template-columns: 1fr;\n    grid-template-rows: auto auto;\n    gap: 1rem;\n    overflow: hidden;\n    box-sizing: border-box;\n    height: fit-content;\n  }\n  \n  .eq-controls {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n  }\n\n  .eq-controls:last-child {\n    padding-bottom: 1rem;\n  }\n\n  @container equalizer-host (min-width: 600px) {\n    .equalizer-container {\n      grid-template-columns: 1fr 1fr;\n      grid-template-rows: 1fr;\n    }\n\n    .eq-controls {\n      padding-bottom: 1rem;\n    }\n  }\n\n  eq-filter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n  }\n\n  .eq-filter-header {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n    padding-bottom: 0.3rem;\n\n    .preamp-row {\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n      gap: 0.2rem;\n      font-size: 0.9rem;\n      font-weight: 600;\n    }\n\n    .eq-filter-button-row {\n      display: flex;\n      flex-direction: row;\n      gap: 0.2rem;\n    }\n  }\n\n  .eq-filter-bands {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n  }\n\n  .eq-filter-band {\n    display: flex;\n    flex-direction: row;\n    align-items: stretch;\n    gap: 0.3rem;\n    padding: 0.4rem;\n    height: 1.5rem;\n    border: 1px solid var(--gt-color-outline);\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface-container);\n\n    label {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    input[type="checkbox"] {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin: 0 0.3rem;\n      border: 0.1rem solid var(--gt-color-outline);\n      width: 0.8rem;\n      height: 0.8rem;\n      accent-color: var(--gt-color-primary);\n    }\n    select {\n      flex: 1;\n      min-width: 3.5rem;\n    }\n    .filter-freq {\n      flex: 2;\n    }\n    .filter-q, .filter-gain {\n      flex: 1;\n    }\n  }\n\n  .eq-data-button-row {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    gap: 0.5rem;\n  }\n\n  eq-select {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 0.5rem;\n    border: 1px solid var(--gt-color-outline);\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface-container);\n\n    select {\n      height: 2rem;\n    }\n  }\n\n  eq-autoeq {\n    padding: 0.5rem;\n    border: 1px solid var(--gt-color-outline);\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface-container);\n    overflow: hidden;\n\n    p {\n      margin: 0.2rem 0;\n      text-align: center;\n    }\n  }\n\n  .auto-eq-container {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.5rem;\n\n    gt-button {\n      width: 100%;\n    }\n  }\n\n  .ae-params {\n    display: flex;\n    flex-direction: column;\n    width: 100%;\n    gap: 0.5rem;\n  }\n\n  .ae-param-row {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    gap: 0.5rem;\n    border: none;\n    padding: 0;\n    margin: 0;\n\n    label { \n      word-break: keep-all;\n      padding: 0rem 0;\n    }\n\n    legend {\n      font-weight: 600;\n      padding: 0;\n      margin-bottom: 0.2rem;\n    }\n\n    input[type="checkbox"] {\n      margin: 0;\n    }\n  }\n\n  .audio-player {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n    padding: 0.5rem;\n    border: 1px solid var(--gt-color-outline);\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface-container);\n  }\n  .ap-audio-source {\n    width: 100%;\n  }\n  .ap-tone-controls {\n    gap: 0.7rem;\n  }\n  .ap-file-info {\n    gap: 0.3rem;\n  }\n  .ap-file-input {\n    cursor: pointer;\n    width: 100%;\n  }\n  .ap-tone-controls, .ap-file-info {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    margin: 0.5rem 0.1rem 0.2rem 0.1rem;\n\n    label {\n      font-weight: 600;\n    }\n    input {\n      margin: 0;\n      width: 100%;\n    }\n    .ap-file-name {\n      margin: 0 0.1rem 0.4rem 0.1rem;\n      overflow-x: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n      max-width: 100%;\n    }\n    .ap-time-info {\n      display: flex;\n      justify-content: space-between;\n      margin: 0 0.1rem 0.2rem 0.1rem;\n      width: 100%;\n    }\n    .ap-time-slider {\n      width: 100%;\n    }\n  }\n  .ap-control {\n    display: flex;\n    flex-direction: row;\n    border: 1px solid var(--gt-color-outline);\n    border-radius: 0.5rem;\n    padding: 0.2rem 0.5rem;\n    background: var(--gt-color-surface-container-lowest);\n\n    .ap-playback-controls {\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n      gap: 0.2rem;\n    }\n    \n    .ap-volume-control {\n      flex: 1;\n      width: 0;\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n      gap: 0.5rem;\n      margin: 0 0.2rem 0 0.5rem;\n\n      label, input {\n        display: flex;\n        align-items: center;\n      }\n      input {\n        flex: 1;\n      }\n    }\n  }\n\n  .ap-filter-toggle {\n    display: flex;\n    align-items: center;\n    margin-right: 0.2rem;\n\n    label {\n      display: flex;\n      align-items: center;\n      gap: 0.2rem;\n    }\n  }\n\n  .eq-uploader {\n    display: flex;\n    flex-direction: row;\n    gap: 0.5rem;\n\n    gt-button {\n      flex: 1;\n      height: 2rem;\n    }\n  }\n\n  equalizer-extension {\n    select, input[type="number"] {\n      width: 100%;\n      padding: 0.2rem;\n      border: 1px solid var(--gt-color-outline);\n      border-radius: 0.4rem;\n      color: var(--gt-color-on-surface);\n      background: var(--gt-color-surface-container-lowest);\n      font: var(--gt-typescale-body-medium);\n    }\n    select {\n      appearance: none;\n      -webkit-appearance: none;\n      -moz-appearance: none;\n      padding-left: 0.3rem;\n      border: 1px solid var(--gt-color-outline);\n      background-repeat: no-repeat;\n      background-position: right center;\n      background-image: url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>\');\n      outline: none;\n      cursor: pointer;\n    }\n\n    input[type="range"] {\n      -webkit-appearance: none;\n      appearance: none;\n    }\n    input[type="range"]::-webkit-slider-runnable-track {\n      -webkit-appearance: none;\n      appearance: none;\n      background: rgba(0,0,0,0.3);\n      border-radius: 0.5rem;\n      height: 0.5rem;\n    }\n    input[type="range"]::-webkit-slider-thumb {\n      -webkit-appearance: none;\n      width: 1rem;\n      height: 1rem;\n      border-radius: 1rem;\n      margin-top: -4px;\n      background: var(--gt-color-primary);\n      cursor: pointer;\n    }\n\n    button {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border: none;\n      background: none;\n      width: 2rem;\n      height: 2rem;\n      cursor: pointer;\n      border-radius: 2rem;\n      color: var(--gt-color-on-surface);\n      -webkit-tap-highlight-color: transparent;\n    }\n    @media (hover: hover) and (pointer: fine) {\n      button:hover {\n        background: var(--gt-color-surface-container-low);\n      }\n    }\n  }\n}\n',this.appendChild(e)}_setupEventListeners(){document.addEventListener("equalizer:select-changed",(e=>{"source"===e.detail.type&&(this.currentSourceUUID=e.detail.uuid),this._updatePreview()})),document.addEventListener("equalizer:select-removed",(e=>{this.currentSourceUUID===e.detail.uuid&&(this.currentSourceUUID=null),this._updatePreview()})),document.addEventListener("equalizer:filters-changed",(e=>{this.currentFilters={filters:e.detail.filters,preamp:e.detail.preamp},this._updatePreview(),this.audioPlayer.updateFilters(this.currentFilters)}))}_updatePreview(){if(null===this.currentSourceUUID)return;const e=this.currentFilters.filters,i=t.getFRData(this.currentSourceUUID);if(!i)return;const n={};let r;Object.keys(i.channels).forEach((t=>{if(i.channels[t]){const r=new Equalizer,a=[...i.channels[t].data.map((e=>e[0]))],s=[...i.channels[t].data.map((e=>e[1]))],l=r.calculateGainsFromFilter(a,e),o=a.map(((e,t)=>[e,s[t]+l[t]]));n[t]={data:o,metadata:{...i.channels[t].metadata}}}}));if(Array.from(t.frDataMap).some((([e,t])=>"inserted-eq"===t.type&&t.identifier===i.identifier&&t.dispSuffix===`${i.dispSuffix.trim()} (EQ)`&&(r=e,!0))))t.updateFRDataWithRawData(r,n,{identifier:`${i.identifier}`,dispSuffix:`${i.dispSuffix} (EQ)`});else{const e=Object.keys(i.channels).includes("AVG")?"AVG":Object.keys(i.channels)[0];t.insertRawFRData("eq",`${i.identifier}`,n,{dispChannel:[e],dispSuffix:`${i.dispSuffix} (EQ)`,basePhoneId:this.currentSourceUUID})}}}customElements.define("equalizer-extension",EqualizerExtension),e.addExtensionMenu("equalizer","EQUALIZER","equalizer-extension");class EQFilterList extends HTMLElement{constructor(){super(),this.config={},this.eqBands=5,this.extraEQBandsMax=20,this.innerHTML=`\n    <div class="eq-filter-header">\n      <div class="preamp-row">\n        <label>${i.getString("extension.equalizer.filter-list.preamp","Preamp")}:</label>\n        <span class="preamp-value">0.0 dB</span>\n      </div>\n      <div class="eq-filter-button-row">\n        <button class="add-filter" title="Add Band">${r.getSVG("plus")}</button>\n        <button class="remove-filter" title="Remove Band">${r.getSVG("subtract")}</button>\n        <button class="sort-filters" title="Sort by Frequency">${r.getSVG("sortDesc")}</button>\n      </div>\n    </div>\n    <div class="eq-filter-bands"></div>\n    <div class="eq-data-button-row">\n      <gt-button class="import-filters" title="Import" variant="outlined" style="flex: 1">\n        ${r.getSVG("import","width: 1rem; height: 1rem;")}\n        <span>${i.getString("extension.equalizer.filter-list.import","Import")}</span>\n      </gt-button>\n      <gt-button class="export-filters" title="Export" variant="outlined" style="flex: 1">\n        ${r.getSVG("export","width: 1rem; height: 1rem;")}\n        <span>${i.getString("extension.equalizer.filter-list.export","Export")}</span>\n      </gt-button>\n    </div>\n    <div class="eq-data-button-row">\n      <gt-button class="export-graphic" title="Export as Graphic EQ" variant="outlined" style="flex: 1">\n        ${r.getSVG("export","width: 1rem; height: 1rem;")}\n        <span>${i.getString("extension.equalizer.filter-list.export-graphic-eq","Export as Graphic EQ (Wavelet)")}</span>\n      </gt-button>\n    </div>\n    `}setConfig(e){this.config=e,this.eqBands=parseInt(e?.INITIAL_EQ_BANDS)||this.eqBands,this.extraEQBandsMax=parseInt(e?.MAXIMUM_EQ_BANDS)||this.extraEQBandsMax,this._setupFilterElements(!0)}connectedCallback(){this._setupEventListener(),document.addEventListener("equalizer:auto-eq-generated",(e=>{const t=e.detail.filters;this._updateFilterElementsWithValues(t),this._dispatchFilterUpdateEvent()})),i.addObserver(this._updateLanguage.bind(this))}_setupFilterElements(e=!0){e&&(this.querySelector(".eq-filter-bands").innerHTML="");const t=e?this.eqBands:1;for(let e=0;e<t;e++){const e=document.createElement("div");e.className="eq-filter-band",e.innerHTML=`\n        <label>\n          <input type="checkbox" checked class="filter-enabled" />\n        </label>\n        <select class="filter-type">\n          <option value="PK">${i.getString("extension.equalizer.filter-list.peak","Peak")}</option>\n          <option value="LSQ">${i.getString("extension.equalizer.filter-list.lowshelf","Low Shelf")}</option>\n          <option value="HSQ">${i.getString("extension.equalizer.filter-list.highshelf","High Shelf")}</option>\n        </select>\n        <input type="number" class="filter-freq" placeholder="${i.getString("extension.equalizer.filter-list.freq","Frequency (Hz)")}" min="20" max="20000" />\n        <input type="number" class="filter-q" placeholder="${i.getString("extension.equalizer.filter-list.q","Q")}" min="0.1" max="10" step="0.1" />\n        <input type="number" class="filter-gain" placeholder="${i.getString("extension.equalizer.filter-list.gain","Gain (dB)")}" min="-30" max="30" step="0.1" />\n      `,this.querySelector(".eq-filter-bands").appendChild(e),e.querySelector(".filter-enabled").addEventListener("change",(()=>this._dispatchFilterUpdateEvent())),e.querySelector(".filter-type").addEventListener("change",(()=>this._dispatchFilterUpdateEvent())),e.querySelectorAll('input[type="number"]').forEach((e=>{e.addEventListener("input",(()=>this._dispatchFilterUpdateEvent()))}))}}_setupEventListener(){this.querySelector(".add-filter").addEventListener("click",(()=>{this.eqBands<this.extraEQBandsMax&&(this.eqBands=Math.min(this.eqBands+1,this.extraEQBandsMax),this._setupFilterElements(!1),this._dispatchFilterUpdateEvent())})),this.querySelector(".remove-filter").addEventListener("click",(()=>{this.eqBands>1&&(this.eqBands=Math.max(this.eqBands-1,1),this.querySelector(".eq-filter-bands").removeChild(this.querySelector(".eq-filter-bands").lastChild),this._dispatchFilterUpdateEvent())})),this.querySelector(".sort-filters").addEventListener("click",(()=>{this._sortFilters(),this._dispatchFilterUpdateEvent()})),this.querySelector(".import-filters").addEventListener("click",(()=>{this._importFilters(),this._dispatchFilterUpdateEvent()})),this.querySelector(".export-filters").addEventListener("click",(()=>{this._exportFilters()})),this.querySelector(".export-graphic").addEventListener("click",(()=>{this._exportGraphicEQ()}))}_getFiltersFromElements(e=!1){const t=[];return this.querySelectorAll(".eq-filter-band").forEach((i=>{const n=i.querySelector(".filter-enabled").checked,r=i.querySelector(".filter-type").value,a=parseFloat(i.querySelector(".filter-freq").value),s=parseFloat(i.querySelector(".filter-q").value),l=parseFloat(i.querySelector(".filter-gain").value);a&&s&&l&&(n||e)&&t.push({enabled:n,type:r,freq:a,q:s,gain:l})})),t}_sortFilters(){const e=this._getFiltersFromElements();e.sort(((e,t)=>e.freq-t.freq)),this._updateFilterElementsWithValues(e)}_updateFilterElementsWithValues(e){this.eqBands=e.length,this._setupFilterElements();const t=this.querySelectorAll(".eq-filter-band");e.forEach(((e,i)=>{const n=t[i];n.querySelector(".filter-enabled").checked=!e.disabled,n.querySelector(".filter-type").value=e.type,n.querySelector(".filter-freq").value=e.freq,n.querySelector(".filter-q").value=e.q,n.querySelector(".filter-gain").value=e.gain}))}_updatePreampDisplay(){const e=this._getFiltersFromElements();if(!e.length)return 0;const t=Array.from({length:100},((e,t)=>20*Math.pow(10,t*Math.log10(1e3)/99))).map((e=>[e,0])),i=new Equalizer;this.preamp=i.calculatePreamp(t,e),this.querySelector(".preamp-value").textContent=`${this.preamp.toFixed(1)} dB`}_importFilters(){const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const t=e.target.files[0],i=new FileReader;i.onload=e=>{const t=e.target.result,i=this._parseFilterText(t);i.length&&(this._updateFilterElementsWithValues(i),this._dispatchFilterUpdateEvent())},i.readAsText(t)},e.click()}_exportFilters(){const e=this._getFiltersFromElements();if(!e.length)return void alert(i.getString("extension.equalizer.filter-list.no-filter-export-alert","Please add at least one filter before exporting."));let t=`Preamp: ${this.preamp.toFixed(1)} dB\n`;e.forEach(((e,i)=>{let n=e.type;"LSQ"!==n&&"HSQ"!==n||(n=n.substr(0,2)+"C"),t+=`Filter ${i+1}: ON ${n} Fc ${e.freq.toFixed(0)} Hz Gain ${e.gain.toFixed(1)} dB Q ${e.q.toFixed(3)}\n`})),this._downloadText(t,"filters.txt")}_exportGraphicEQ(){const e=this._getFiltersFromElements();if(!e.length)return void alert(i.getString("extension.equalizer.filter-list.no-filter-export-alert","Please add at least one filter before exporting."));const t="GraphicEQ: "+(new Equalizer).convertFilterAsGraphicEQ(e).map((([e,t])=>`${e.toFixed(0)} ${t.toFixed(1)}`)).join("; ");this._downloadText(t,"graphic_eq.txt")}_downloadText(e,t){const i=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(i),r=document.createElement("a");r.href=n,r.download=t,r.click(),URL.revokeObjectURL(n)}_parseFilterText(e){const t=[],i=e.split("\n");for(const e of i)if(e.startsWith("Preamp:")){const t=e.match(/Preamp:\s*([+-]?\d*\.?\d+)\s*dB/);t&&(this.preamp=parseFloat(t[1]),this.querySelector(".preamp-value").textContent=`${this.preamp.toFixed(1)} dB`)}else if(e.includes("Filter")){const i=e.match(/(\w+)\s+Fc\s+(\d+)\s+Hz\s+Gain\s+([+-]?\d*\.?\d+)\s+dB\s+Q\s+([+-]?\d*\.?\d+)/);if(i){const[e,n,r,a,s]=i;t.push({enabled:!0,type:"LSC"===n?"LSQ":"HSC"===n?"HSQ":n,freq:parseFloat(r),gain:parseFloat(a),q:parseFloat(s)})}}return t}_updateLanguage(){const e=this.querySelector(".preamp-row > label");e&&(e.innerHTML=i.getString("extension.equalizer.filter-list.preamp","Preamp")+":");const t=this.querySelector(".import-filters > span");t&&(t.innerHTML=i.getString("extension.equalizer.filter-list.import","Import"));const n=this.querySelector(".export-filters > span");n&&(n.innerHTML=i.getString("extension.equalizer.filter-list.export","Export"));const r=this.querySelector(".export-graphic > span");r&&(r.innerHTML=i.getString("extension.equalizer.filter-list.export-graphic-eq","Export as Graphic EQ (Wavelet)"));const a=this.querySelectorAll('.filter-type > option[value="PK"]');a&&a.forEach((e=>e.innerHTML=i.getString("extension.equalizer.filter-list.peak","Peak")));const s=this.querySelectorAll('.filter-type > option[value="LSQ"]');s&&s.forEach((e=>e.innerHTML=i.getString("extension.equalizer.filter-list.lowshelf","Low Shelf")));const l=this.querySelectorAll('.filter-type > option[value="HSQ"]');l&&l.forEach((e=>e.innerHTML=i.getString("extension.equalizer.filter-list.highshelf","High Shelf")));const o=this.querySelectorAll(".filter-freq");o&&o.forEach((e=>e.placeholder=i.getString("extension.equalizer.filter-list.freq","Frequency (Hz)")));const u=this.querySelectorAll(".filter-q");u&&u.forEach((e=>e.placeholder=i.getString("extension.equalizer.filter-list.q","Q")));const c=this.querySelectorAll(".filter-gain");c&&c.forEach((e=>e.placeholder=i.getString("extension.equalizer.filter-list.gain","Gain (dB)")))}_dispatchFilterUpdateEvent(){this._updatePreampDisplay(),this.dispatchEvent(new CustomEvent("equalizer:filters-changed",{bubbles:!0,composed:!0,detail:{filters:this._getFiltersFromElements(),preamp:this.preamp,eqBandCount:this.eqBands}}))}}customElements.define("eq-filter-list",EQFilterList);var s=Object.freeze({__proto__:null});class EQSelect extends HTMLElement{constructor(){super(),this.innerHTML=`\n      <select class="eq-source-select">\n        <option value="">\n          ${i.getString("extension.equalizer.phone-select.option-source","Select device to EQ")}\n        </option>\n      </select>\n      ${r.getSVG("arrowDown")}\n      <select class="eq-target-select">\n        <option value="">\n          ${i.getString("extension.equalizer.phone-select.option-target","Select target for AutoEQ")}\n        </option>\n      </select>\n    `,this.sourceSelect=this.querySelector(".eq-source-select"),this.targetSelect=this.querySelector(".eq-target-select")}connectedCallback(){this._setupGraphSelector(null,!0),this._setupEventListeners()}_setupGraphSelector(e=null,n=!1){if(n)this.sourceSelect.innerHTML=`<option value="">\n        ${i.getString("extension.equalizer.phone-select.option-source","Select device to EQ")}\n      </option>`,this.targetSelect.innerHTML=`<option value="">\n        ${i.getString("extension.equalizer.phone-select.option-target","Select target for AutoEQ")}\n      </option>`,Array.from(t.frDataMap).forEach((([e,t])=>{if("inserted-eq"!==t.type){const i=document.createElement("option");i.value=e,i.textContent=`${t.identifier} ${t.dispSuffix||""}`.trim(),"phone"===t.type&&this.sourceSelect.appendChild(i.cloneNode(!0)),this.targetSelect.appendChild(i)}}));else{const i=t.getFRData(e),n=document.createElement("option");n.value=e,n.textContent=`${i.identifier} ${i.dispSuffix||""}`.trim(),"phone"===i.type&&this.sourceSelect.appendChild(n.cloneNode(!0)),this.targetSelect.appendChild(n.cloneNode(!0))}this._sortSelectOptions()}_setupEventListeners(){window.addEventListener("core:fr-phone-added",(e=>this._setupGraphSelector(e.detail.uuid))),window.addEventListener("core:fr-target-added",(e=>this._setupGraphSelector(e.detail.uuid))),window.addEventListener("core:fr-phone-removed",(e=>{this.sourceSelect.querySelector(`option[value="${e.detail.uuid}"]`).remove(),this.targetSelect.querySelector(`option[value="${e.detail.uuid}"]`).remove(),this._dispatchSelectRemovedEvent(e.detail.uuid)})),window.addEventListener("core:fr-target-removed",(e=>{this.targetSelect.querySelector(`option[value="${e.detail.uuid}"]`).remove(),this._dispatchSelectRemovedEvent(e.detail.uuid)})),this.sourceSelect.addEventListener("change",(()=>this._dispatchSelectEvent("source",this.sourceSelect.value))),this.targetSelect.addEventListener("change",(()=>this._dispatchSelectEvent("target",this.targetSelect.value))),i.addObserver(this._updateLanguage.bind(this))}_sortSelectOptions(){Array.from(this.sourceSelect.children).sort(((e,t)=>e.value?t.value?e.textContent.localeCompare(t.textContent):1:-1)).forEach((e=>this.sourceSelect.appendChild(e))),Array.from(this.targetSelect.children).sort(((e,t)=>{if(!e.value)return-1;if(!t.value)return 1;const i=e.textContent.endsWith(" Target"),n=t.textContent.endsWith(" Target");return i&&!n?-1:!i&&n?1:e.textContent.localeCompare(t.textContent)})).forEach((e=>this.targetSelect.appendChild(e)))}_updateLanguage(){const e=this.sourceSelect.querySelector('option[value=""]');e&&(e.innerHTML=i.getString("extension.equalizer.phone-select.option-source","Select device to EQ"));const t=this.targetSelect.querySelector('option[value=""]');t&&(t.innerHTML=i.getString("extension.equalizer.phone-select.option-target","Select target for AutoEQ"))}_dispatchSelectEvent(e,t){this.dispatchEvent(new CustomEvent("equalizer:select-changed",{bubbles:!0,composed:!0,detail:{type:e,uuid:t}}))}_dispatchSelectRemovedEvent(e){this.dispatchEvent(new CustomEvent("equalizer:select-removed",{bubbles:!0,composed:!0,detail:{uuid:e}}))}}customElements.define("eq-select",EQSelect);var l=Object.freeze({__proto__:null});class EQAudioPlayer extends HTMLElement{constructor(){super(),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.noiseNode=null,this.sourceNode=null,this.oscillatorNode=null,this.filterNodes=[],this.filtersEnabled=!0,this.isPlaying=!1,this.isSeeking=!1,this.seekTimeout=null,this.startTime=0,this.pausedAt=0,this.currentTime=0,this.innerHTML=`\n      <div class="audio-player">\n        <select class="ap-audio-source">\n          <option value="">${i.getString("extension.equalizer.player.option-init","Select Audio Source")}</option>\n          <option value="white">${i.getString("extension.equalizer.player.option-white","White Noise")}</option>\n          <option value="pink">${i.getString("extension.equalizer.player.option-pink","Pink Noise")}</option>\n          <option value="tone">${i.getString("extension.equalizer.player.option-tone","Tone Generator")}</option>\n          <option value="file">${i.getString("extension.equalizer.player.option-file","Audio File")}</option>\n        </select>\n        <div class="ap-tone-controls" style="display: none;">\n          <div class="ap-tone-row">\n            <label class="ap-tone-freq-label">${i.getString("extension.equalizer.player.tone-freq-label","Frequency: ")}</label>\n            <label><span class="ap-freq-value">1000</span> Hz</label>\n          </div>\n          <input type="range" class="ap-freq-slider" min="0" max="1000" step="1" value="699">\n        </div>\n        <div class="ap-file-upload-section" style="display: none;">\n          <input type="file" class="ap-file-input" accept="audio/*">\n        </div>\n        <div class="ap-file-info" style="display: none;">\n          <div class="ap-time-slider">\n            <input type="range" class="ap-position-slider" min="0" max="100" step="0.1" value="0">\n          </div>\n          <span class="ap-time-info">\n            <span class="ap-current-time">0:00</span>\n            <span class="ap-total-time">0:00</span>\n          </span>\n        </div>\n        <div class="ap-control">\n          <div class="ap-playback-controls">\n            <button class="ap-prev-button">${r.getSVG("previous")}</button>\n            <button class="ap-play-button">${r.getSVG("play")}</button>\n          </div>\n          <gt-divider style="width: 2px; margin: 0.1rem 0.5rem"></gt-divider>\n          <div class="ap-volume-control">\n            <label class="ap-volume-slider-icon">${r.getSVG("volumeFull","width: 1rem; height: 1rem;")}</label>\n            <input type="range" class="ap-volume-slider" min="0" max="1" step="0.01" value="0.1">\n          </div>\n        </div>\n        <div class="ap-filter-toggle">\n          <label class="ap-filter-checkbox-label">\n            <input type="checkbox" class="ap-filter-checkbox" checked>\n            <span>\n              ${i.getString("extension.equalizer.player.filter-toggle","EQ Effect")}\n            </span>\n          </label>\n        </div>\n      </div>\n    `}connectedCallback(){this._handleAudioSourceChange=this._handleAudioSourceChange.bind(this),this._handleFileInputChange=this._handleFileInputChange.bind(this),this._handlePrevBtnClick=this._handlePrevBtnClick.bind(this),this._handlePlayBtnClick=this._handlePlayBtnClick.bind(this),this._handleFreqSliderChange=this._handleFreqSliderChange.bind(this),this._handlePositionSliderMouseDown=this._handlePositionSliderMouseDown.bind(this),this._handlePositionSliderMouseUp=this._handlePositionSliderMouseUp.bind(this),this._handlePositionSliderInput=this._handlePositionSliderInput.bind(this),this._handleVolumeSliderInput=this._handleVolumeSliderInput.bind(this),this._handleFilterToggleChange=this._handleFilterToggleChange.bind(this),this.querySelector(".ap-audio-source").addEventListener("change",this._handleAudioSourceChange),this.querySelector(".ap-file-input").addEventListener("change",this._handleFileInputChange),this.querySelector(".ap-prev-button").addEventListener("click",this._handlePrevBtnClick),this.querySelector(".ap-play-button").addEventListener("click",this._handlePlayBtnClick),this.querySelector(".ap-freq-slider").addEventListener("input",this._handleFreqSliderChange),this.querySelector(".ap-position-slider").addEventListener("mousedown",this._handlePositionSliderMouseDown),this.querySelector(".ap-position-slider").addEventListener("mouseup",this._handlePositionSliderMouseUp),this.querySelector(".ap-position-slider").addEventListener("input",this._handlePositionSliderInput),this.querySelector(".ap-volume-slider").addEventListener("input",this._handleVolumeSliderInput),this.querySelector(".ap-filter-checkbox").addEventListener("change",this._handleFilterToggleChange),i.addObserver(this._updateLanguage.bind(this))}disconnectedCallback(){this.stopAudio(),this.querySelector(".ap-audio-source").removeEventListener("change",this._handleAudioSourceChange),this.querySelector(".ap-file-input").removeEventListener("change",this._handleFileInputChange),this.querySelector(".ap-prev-button").removeEventListener("click",this._handlePrevBtnClick),this.querySelector(".ap-play-button").removeEventListener("click",this._handlePlayBtnClick),this.querySelector(".ap-freq-slider").removeEventListener("input",this._handleFreqSliderChange),this.querySelector(".ap-position-slider").removeEventListener("mousedown",this._handlePositionSliderMouseDown),this.querySelector(".ap-position-slider").removeEventListener("mouseup",this._handlePositionSliderMouseUp),this.querySelector(".ap-position-slider").removeEventListener("input",this._handlePositionSliderInput),this.querySelector(".ap-volume-slider").removeEventListener("input",this._handleVolumeSliderInput),this.querySelector(".ap-filter-checkbox").removeEventListener("change",this._handleFilterToggleChange),i.removeObserver(this._updateLanguage.bind(this))}_handleAudioSourceChange(e){this.isPlaying&&this.stopAudio(),this.querySelector(".ap-tone-controls").style.display="tone"===e.target.value?"flex":"none",this.querySelector(".ap-file-upload-section").style.display="file"===e.target.value?"block":"none","file"!==e.target.value&&(this.querySelector(".ap-file-info").style.display="none",this.querySelector(".ap-file-input").value="",this.audioBuffer=null)}_handleFileInputChange(e){const t=e.target.files[0];t&&this._loadAudioFile(t)}_handlePrevBtnClick(){this.resetAudio()}_handlePlayBtnClick(){this.isPlaying?this.pauseAudio():this.playAudio()}_handleFreqSliderChange(e){const t=Math.log10(20),i=(Math.log10(2e4)-t)/1e3,n=Math.round(Math.pow(10,t+e.target.value*i));this.querySelector(".ap-freq-value").textContent=n,this.oscillatorNode&&this.isPlaying&&this.oscillatorNode.frequency.setValueAtTime(n,this.audioContext.currentTime)}_handlePositionSliderMouseDown(){this.isSeeking=!0}_handlePositionSliderMouseUp(e){if(!this.audioBuffer)return;const t=e.target.value/100*this.audioBuffer.duration;this.seekTo(t),clearTimeout(this.seekTimeout),this.seekTimeout=setTimeout((()=>{this.isSeeking=!1}),200)}_handlePositionSliderInput(e){if(!this.audioBuffer)return;const t=e.target.value/100*this.audioBuffer.duration;this.pausedAt=t,this._updateTimeDisplay()}_handleVolumeSliderInput(e){this._updateVolume(e.target.value),"0"===e.target.value?this.querySelector(".ap-volume-slider-icon").innerHTML=r.getSVG("volumeMute","width: 1rem; height: 1rem;"):this.querySelector(".ap-volume-slider-icon").innerHTML=r.getSVG("volumeFull","width: 1rem; height: 1rem;")}_handleFilterToggleChange(e){this.filtersEnabled=e.target.checked,this._reconnectAudioChain()}_loadAudioFile(e){const t=new FileReader;t.onload=async e=>{try{this.audioBuffer=await this.audioContext.decodeAudioData(e.target.result),this.querySelector(".ap-file-info").style.display="flex",this.querySelector(".ap-total-time").textContent=this._formatTime(this.audioBuffer.duration),this.pausedAt=0,this._updateTimeDisplay()}catch(e){console.error("Error loading audio file:",e)}},t.readAsArrayBuffer(e)}_createAndStartAudioSource(e=this.pausedAt){this.sourceNode=this.audioContext.createBufferSource(),this.sourceNode.buffer=this.audioBuffer,this.sourceNode.start(0,e),this.filtersEnabled&&this.filterNodes.length>0?this.sourceNode.connect(this.filterNodes[0]):this.sourceNode.connect(this.gainNode),this.sourceNode.onended=()=>{this.isPlaying&&!this.isSeeking&&(this.pausedAt=0,this.isPlaying=!1,this.querySelector(".ap-play-button").innerHTML=r.getSVG("play"),this._updateTimeDisplay())}}_createNoiseNode(e){const t=2*this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),n=i.getChannelData(0);if("white"===e)for(let e=0;e<t;e++)n[e]=2*Math.random()-1;else if("pink"===e){let e=0,i=0,r=0,a=0,s=0,l=0,o=0;for(let u=0;u<t;u++){const t=2*Math.random()-1;e=.99886*e+.0555179*t,i=.99332*i+.0750759*t,r=.969*r+.153852*t,a=.8665*a+.3104856*t,s=.55*s+.5329522*t,l=-.7616*l-.016898*t,o=.115926*t,n[u]=e+i+r+a+s+l+o+.5362*t,n[u]*=.11}}const r=this.audioContext.createBufferSource();return r.buffer=i,r.loop=!0,r}_createToneGenerator(){const e=this.audioContext.createOscillator();e.type="sine";const t=Math.log10(20),i=(Math.log10(2e4)-t)/1e3,n=this.querySelector(".ap-freq-slider").value,r=Math.round(Math.pow(10,t+n*i));return e.frequency.value=r,e}_reconnectAudioChain(){if(!this.gainNode)return;let e=null;this.sourceNode?e=this.sourceNode:this.oscillatorNode&&(e=this.oscillatorNode),e&&(e.disconnect(),this.filtersEnabled&&this.filterNodes.length>0?e.connect(this.filterNodes[0]):e.connect(this.gainNode))}updateFilters(e){if(!this.gainNode)return;if(this.filterNodes.forEach((e=>e.disconnect())),this.filterNodes=[],!(e&&e.filters&&0!==e.filters.length&&e.preamp&&this.filtersEnabled))return void this._reconnectAudioChain();const t=this.audioContext.createGain();if(t.gain.value=Math.pow(10,e.preamp/20),this.filterNodes.push(t),e.filters.forEach((e=>{const t=this.audioContext.createBiquadFilter();switch(e.type){case"PK":t.type="peaking";break;case"LSQ":t.type="lowshelf";break;case"HSQ":t.type="highshelf"}t.frequency.value=e.freq,t.Q.value=e.q,t.gain.value=e.gain,this.filterNodes.push(t)})),this.filterNodes.length>1)for(let e=0;e<this.filterNodes.length-1;e++)this.filterNodes[e].connect(this.filterNodes[e+1]);this.filterNodes.length>0&&this.filterNodes[this.filterNodes.length-1].connect(this.gainNode),this._reconnectAudioChain()}playAudio(){const e=this.querySelector(".ap-audio-source").value;if(e){if(this.sourceNode&&this.sourceNode.disconnect(),this.oscillatorNode&&(this.oscillatorNode.disconnect(),this.oscillatorNode=null),this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.querySelector(".ap-volume-slider").value),"white"===e||"pink"===e)try{this.sourceNode=this._createNoiseNode(e),this.filtersEnabled&&this.filterNodes.length>0?this.sourceNode.connect(this.filterNodes[0]):this.sourceNode.connect(this.gainNode),this.sourceNode.start()}catch(e){console.error("Error starting noise node:",e)}else if("tone"===e)this.oscillatorNode=this._createToneGenerator(),this.filtersEnabled&&this.filterNodes.length>0?this.oscillatorNode.connect(this.filterNodes[0]):this.oscillatorNode.connect(this.gainNode),this.oscillatorNode.start();else{if("file"!==e||!this.audioBuffer)return;this._createAndStartAudioSource()}this.startTime=this.audioContext.currentTime,this.isPlaying=!0,this.querySelector(".ap-play-button").innerHTML=r.getSVG("pause"),"file"===e&&this._updateTimeDisplay()}}resetAudio(){this.isPlaying&&this.stopAudio(),this.pausedAt=0,this._updateTimeDisplay(),this.playAudio()}pauseAudio(){this.isPlaying&&(this.sourceNode&&(this.sourceNode.stop(),this.sourceNode.disconnect()),this.oscillatorNode&&(this.oscillatorNode.stop(),this.oscillatorNode.disconnect()),this.pausedAt+=this.audioContext.currentTime-this.startTime,this.isPlaying=!1,this.querySelector(".ap-play-button").innerHTML=r.getSVG("play"))}stopAudio(){this.sourceNode&&(this.sourceNode.stop(),this.sourceNode.disconnect(),this.sourceNode=null),this.oscillatorNode&&(this.oscillatorNode.stop(),this.oscillatorNode.disconnect(),this.oscillatorNode=null),this.isPlaying=!1,this.querySelector(".ap-play-button").innerHTML=r.getSVG("play")}seekTo(e){this.audioBuffer&&(this.isPlaying?(this.sourceNode.stop(),this._createAndStartAudioSource(e),this.startTime=this.audioContext.currentTime,this.pausedAt=e,this.querySelector(".ap-play-button").innerHTML=r.getSVG("pause")):(this.pausedAt=e,this._updateTimeDisplay()))}_updateVolume(e){this.gainNode&&(this.gainNode.gain.value=e)}_formatTime(e){return`${Math.floor(e/60)}:${(e=Math.floor(e%60)).toString().padStart(2,"0")}`}_updateTimeDisplay(){if(!this.audioBuffer)return;let e;e=this.isPlaying?Math.min(this.audioContext.currentTime-this.startTime+this.pausedAt,this.audioBuffer.duration):this.pausedAt,this.querySelector(".ap-current-time").textContent=this._formatTime(e),this.querySelector(".ap-position-slider").value=e/this.audioBuffer.duration*100,this.isPlaying&&requestAnimationFrame((()=>this._updateTimeDisplay()))}_updateLanguage(){const e=this.querySelector(".ap-audio-source");if(e){const t={"":["extension.equalizer.player.option-init","Select Audio Source"],white:["extension.equalizer.player.option-white","White Noise"],pink:["extension.equalizer.player.option-pink","Pink Noise"],tone:["extension.equalizer.player.option-tone","Tone Generator"],file:["extension.equalizer.player.option-file","Audio File"]};Object.entries(t).forEach((([t,[n,r]])=>{const a=e.querySelector(`option[value="${t}"]`);a&&(a.textContent=i.getString(n,r))}))}const t=this.querySelector(".ap-tone-freq-label");t&&(t.textContent=i.getString("extension.equalizer.player.tone-freq-label","Frequency: "));const n=this.querySelector(".ap-filter-checkbox-label");if(n){const e=n.querySelector('input[type="checkbox"]'),t=i.getString("extension.equalizer.player.filter-toggle","EQ Effect");n.innerHTML="",n.appendChild(e),n.appendChild(document.createTextNode(t))}}}customElements.define("eq-audio-player",EQAudioPlayer);var o=Object.freeze({__proto__:null});class EQAutoEQ extends HTMLElement{constructor(){super(),this.config={},this.worker=null,this.workerReady=!1,this.pendingRequests=new Map,this.requestId=0,this.currentDeviceUUID={source:null,target:null},this.currentEQBands=10,this.innerHTML=`\n      <div class="auto-eq-container">\n        <div class="ae-params">\n          <fieldset class="ae-param-row">\n            <legend class="ae-filter-label">${i.getString("extension.equalizer.autoeq.filter-setting","Filter Settings")}</legend>\n            <label class="ae-use-shelf-filter-label" for="ae-use-shelf-filter-input">${i.getString("extension.equalizer.autoeq.use-shelf-filter","Use LSF / HSF Filter")}</label>\n            <input type="checkbox" id="ae-use-shelf-filter-input" checked>\n          </fieldset>\n          <fieldset class="ae-param-row">\n            <legend class="ae-freq-label">${i.getString("extension.equalizer.autoeq.freq-range","Frequency Range")}</legend>\n            <label class="ae-min-label" for="ae-freq-min-input">${i.getString("extension.equalizer.autoeq.min","Min")}</label>\n            <input type="number" id="ae-freq-min-input" value="20" min="20" max="20000">\n            <label class="ae-max-label" for="ae-freq-max-input">${i.getString("extension.equalizer.autoeq.max","Max")}</label>\n            <input type="number" id="ae-freq-max-input" value="15000" min="20" max="20000">\n          </fieldset>\n          <fieldset class="ae-param-row">\n            <legend class="ae-q-label">${i.getString("extension.equalizer.autoeq.q-range","Q Range")}</legend>\n            <label class="ae-min-label" for="ae-q-min-input">${i.getString("extension.equalizer.autoeq.min","Min")}</label>\n            <input type="number" id="ae-q-min-input" value="0.5" min="0.1" max="10" step="0.1">\n            <label class="ae-max-label" for="ae-q-max-input">${i.getString("extension.equalizer.autoeq.max","Max")}</label>\n            <input type="number" id="ae-q-max-input" value="2.0" min="0.1" max="10" step="0.1">\n          </fieldset>\n          <fieldset class="ae-param-row">\n            <legend class="ae-gain-label">${i.getString("extension.equalizer.autoeq.gain-range","Gain Range")}</legend>\n            <label class="ae-min-label" for="ae-gain-min-input">${i.getString("extension.equalizer.autoeq.min","Min")}</label>\n            <input type="number" id="ae-gain-min-input" value="-12" min="-40" max="0">\n            <label class="ae-max-label" for="ae-gain-max-input">${i.getString("extension.equalizer.autoeq.max","Max")}</label>\n            <input type="number" id="ae-gain-max-input" value="12" min="0" max="40">\n          </fieldset>\n        </div>\n        <p class="ae-description">${i.getString("extension.equalizer.autoeq.description","AutoEQ will use as many filters as available.")}</p>\n        <gt-button class="ae-generate-eq">${i.getString("extension.equalizer.autoeq.run-button","Run AutoEQ")}</gt-button>\n      </div>\n    `,this._initWorker()}_initWorker(){try{const e=new URL("./util/equalizer.worker.js",import.meta.url);this.worker=new Worker(e,{type:"classic"}),this.workerReady=!0,this.worker.onmessage=e=>{const{type:t,id:i,payload:n}=e.data,r=this.pendingRequests.get(i);r&&(this.pendingRequests.delete(i),"result"===t?r.resolve(n.filters):"error"===t&&r.reject(new Error(n.message)))},this.worker.onerror=e=>{console.warn("AutoEQ Worker error, falling back to main thread:",e.message),this.workerReady=!1}}catch(e){console.warn("Failed to initialize AutoEQ Worker, falling back to main thread:",e.message),this.workerReady=!1}}_runAutoEQInWorker(e,t,i){return new Promise(((n,r)=>{const a=++this.requestId;this.pendingRequests.set(a,{resolve:n,reject:r}),this.worker.postMessage({type:"autoEQ",id:a,payload:{source:e,target:t,options:i}}),setTimeout((()=>{this.pendingRequests.has(a)&&(this.pendingRequests.delete(a),r(new Error("AutoEQ computation timed out")))}),3e4)}))}connectedCallback(){this._setupEventListeners(),i.addObserver(this._updateLanguage.bind(this))}disconnectedCallback(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear()}setConfig(e){this.config=e,this.currentEQBands=parseInt(e?.INITIAL_EQ_BANDS)||this.currentEQBands}_setupEventListeners(){document.addEventListener("equalizer:select-changed",(e=>{this.currentDeviceUUID[e.detail.type]=e.detail.uuid})),document.addEventListener("equalizer:select-removed",(e=>{Object.keys(this.currentDeviceUUID).forEach((t=>{this.currentDeviceUUID[t]===e.detail.uuid&&(this.currentDeviceUUID[t]=null)}))})),document.addEventListener("equalizer:filters-changed",(e=>{this.currentEQBands=e.detail.eqBandCount})),this.querySelector(".ae-generate-eq").addEventListener("click",(async()=>{this.setAttribute("aria-busy","true"),await this._generateEQ(),this.setAttribute("aria-busy","false")}))}async _generateEQ(){const e=this.currentDeviceUUID.source,i=this.currentDeviceUUID.target;if(!e||!i)return void alert("Please select both source and target graphs");const n=t.getFRData(e),r=t.getFRData(i),a=parseInt(this.querySelector("#ae-freq-min-input").value)||20,s=parseInt(this.querySelector("#ae-freq-max-input").value)||15e3,l=parseFloat(this.querySelector("#ae-q-min-input").value)||.5,o=parseFloat(this.querySelector("#ae-q-max-input").value)||2,u=parseFloat(this.querySelector("#ae-gain-min-input").value)||-12,c=parseFloat(this.querySelector("#ae-gain-max-input").value)||12,h=this.querySelector("#ae-use-shelf-filter-input").checked,getChannelData=e=>e.channels?.AVG?.data||e.channels?.L?.data||e.channels?.R?.data||e.channels.data,d=getChannelData(n)||[],p=getChannelData(r)||[],g={maxFilters:this.currentEQBands,freqRange:[a,s],qRange:[l,o],gainRange:[u,c],useShelfFilter:h};let f;if(this.worker&&this.workerReady)try{f=await this._runAutoEQInWorker(d,p,g)}catch(e){console.warn("Worker failed, falling back to main thread:",e);f=(new Equalizer).autoEQ(d,p,g)}else f=await new Promise((e=>{requestAnimationFrame((()=>{const t=(new Equalizer).autoEQ(d,p,g);e(t)}))}));this.dispatchEvent(new CustomEvent("equalizer:auto-eq-generated",{bubbles:!0,composed:!0,detail:{filters:f}}))}_updateLanguage(){const e=this.querySelector(".ae-freq-label");e&&(e.innerHTML=i.getString("extension.equalizer.autoeq.freq-range","Frequency Range"));const t=this.querySelector(".ae-q-label");t&&(t.innerHTML=i.getString("extension.equalizer.autoeq.q-range","Q Range"));const n=this.querySelector(".ae-gain-label");n&&(n.innerHTML=i.getString("extension.equalizer.autoeq.gain-range","Gain Range"));const r=this.querySelector(".ae-use-shelf-filter-label");r&&(r.innerHTML=i.getString("extension.equalizer.autoeq.use-shelf-filter","Use Shelf Filter"));const a=this.querySelector(".ae-description");a&&(a.innerHTML=i.getString("extension.equalizer.autoeq.description","AutoEQ will use as many filters as available."));const s=this.querySelector(".ae-generate-eq");s&&(s.innerHTML=i.getString("extension.equalizer.autoeq.run-button","Run AutoEQ"));this.querySelectorAll(".ae-min-label").forEach((e=>{e.innerHTML=i.getString("extension.equalizer.autoeq.min","Min")}));this.querySelectorAll(".ae-max-label").forEach((e=>{e.innerHTML=i.getString("extension.equalizer.autoeq.max","Max")}))}}customElements.define("eq-autoeq",EQAutoEQ);var u=Object.freeze({__proto__:null});class EQUploader extends HTMLElement{constructor(e={}){super(),this.innerHTML=`\n      <div class="eq-uploader extra-upload">\n        <gt-button class="eu-upload-fr-btn" variant="outlined">\n          ${r.getSVG("import","width: 1rem; height: 1rem;")}\n          ${i.getString("extension.equalizer.upload.fr","Upload FR")}\n        </gt-button>\n        <gt-button class="eu-upload-target-btn" variant="outlined">\n          ${r.getSVG("import","width: 1rem; height: 1rem;")}\n          ${i.getString("extension.equalizer.upload.target","Upload Target")}\n        </gt-button>\n      </div>\n    `,this._createFileInput("phone"),this._createFileInput("target"),this.querySelector(".eu-upload-fr-btn").addEventListener("click",(()=>{this._handleUpload("phone")})),this.querySelector(".eu-upload-target-btn").addEventListener("click",(()=>{this._handleUpload("target")})),i.addObserver(this._handleLanguageChange.bind(this))}_createFileInput(e){const t=document.createElement("input");t.type="file",t.accept=".txt",t.hidden=!0,t.dataset.sourceType=e,t.addEventListener("change",(e=>this._parseAndInsertData(e))),this.appendChild(t)}_handleUpload(e){this.querySelector(`input[data-source-type="${e}"]`).click()}async _parseAndInsertData(e){const i=e.target.files[0],r=e.target.dataset.sourceType;if(i)try{const e=await i.text(),a={AVG:await n.parseFRData(e)};await t.insertRawFRData(r,i.name.split(".")[0],a,{dispSuffix:"Uploaded",dispChannel:["AVG"]})}catch(e){console.error("Error processing file:",e),alert("Invalid file format. Please check the file structure.")}finally{e.target.value=""}}_handleLanguageChange(){this.querySelector(".eu-upload-fr-btn").textContent=i.getString("extension.equalizer.upload.fr","Upload FR"),this.querySelector(".eu-upload-target-btn").textContent=i.getString("extension.equalizer.upload.target","Upload Target")}}customElements.define("eq-uploader",EQUploader);var c=Object.freeze({__proto__:null});export{a as EXTENSION_METADATA,EqualizerExtension as default};
//# sourceMappingURL=main.js.map
